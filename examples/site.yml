---
# File: site.yml - Example Consul site playbook

- name: Assemble Consul cluster
  hosts: consul_instances
  any_errors_fatal: true
  become: true
  become_user: root

  vars:
    # Role: RHSM
    rhsm_username: "{{ lookup('env', 'RHSM_USERNAME') }}"
    rhsm_password: "{{ lookup('env', 'RHSM_PASSWORD') }}"
    rhsm_auto_attach: true
    rhsm_server_proxy_hostname: "{{ lookup('env', 'http_proxy_hostname') }}"
    rhsm_server_proxy_port: "{{ lookup('env', 'http_proxy_port') }}"
    rhsm_server_proxy_user: "{{ lookup('env', 'http_proxy_user') }}"
    rhsm_server_proxy_password: "{{ lookup('env', 'http_proxy_password') }}"
    rhsm_consumer_name: "nycrecords_consul_{{ '%Y%m%d_%H%M%s' | strftime(ansible_date_time.epoch) }}"
    rhsm_repositories:
      enabled:
        - rhel-7-server-rpms
        - rhel-7-server-optional-rpms
        - rhel-7-server-extras-rpms
        - rhel-server-rhscl-7-rpms


  roles:
    - name: nycrecords.ansible-role-rhsm
      when: ansible['os_family'] == 'RedHat'
    - name: nycrecords.ansible-consul

  tasks:
    - name: Install Nginx (RedHat)

    - name: Allow Nginx to Act as Reverse Proxy
      seboolean:
        name: httpd_can_network_connect
        state: yes
        persistent: yes

    - name: Setup SELinux for HTTPD Reverse Proxy
      seport:
        ports: 8080
        proto: tcp
        setype: http_port_t
        state: present
